# BidFlow 최종 종합 보고서

- 프로젝트: `BidFlow` (`AI6_6team_Intermediate-Project`)
- 팀: `임창현, 김보윤, 김슬기`
- 작성일: `2026-02-26`
- 보고서 목적: 구현 기능, 실험 의사결정, 보안/운영 준비도를 하나의 문서에서 추적 가능하게 정리

## 1. Executive Summary

BidFlow는 공공 RFP 분석에서 가장 치명적인 실패인 `핵심 조건 누락`을 줄이기 위해 개발한 보안형 RAG 시스템입니다.  
핵심 설계는 `LLM은 추출`, `룰 엔진은 판정`으로 역할을 분리한 구조입니다.

최종 성과:

- 구현 측면: 업로드-추출-검증-협업까지 Next.js + FastAPI 단일 동선 완성
- 실험 측면: EXP01~EXP22를 one-lever 방식으로 운영해 개선/퇴행 원인을 분리
- 성능/안정성: EXP21 P1 단일 `0.9968 (48/50)`, P1-R 3-run gate pass-rate `100%`
- 실운영형 평가: EXP22 non-oracle 3-run mean `kw_v5=0.9742`, `Faithfulness=0.9402`, `Context Recall=0.9778`
- 보안/경계: Input Rail, PII Filter, Tool Gate, 사용자/팀 데이터 분리 적용

## 2. 구현된 기능과 동작 방식

### 2.1 End-to-End 흐름

1. 사용자 로그인 후 문서 업로드
2. 파서가 문서를 청킹/정규화하고 저장소 + 벡터DB에 적재
3. Hybrid Retrieval(BM25+Vector+RRF+Rerank)로 컨텍스트 구성
4. G1~G4 추출 체인 실행
5. RuleBasedValidator로 회사 프로필 대비 판정
6. 팀 워크스페이스에서 판정/코멘트 공유

### 2.2 기능 구현 매핑

| 기능 | 구현 방법 | 근거 파일 |
|---|---|---|
| 업로드/파싱 | `/api/v1/ingest/upload` -> `IngestService`가 확장자별 파싱 후 저장/인덱싱 | `src/bidflow/api/routers/ingest.py`, `src/bidflow/ingest/service.py` |
| 배치 업로드/분석 | 2개 이상 문서 동시 업로드 시 배치 UI + 일괄 추출 처리, 진행률 표시 | `src/bidflow/extraction/batch_pipeline.py`, `frontend/app/dashboard/page.tsx` |
| 파서 계층 | PDF/HWP/DOCX/HWPX 파서 모듈 + HWP HTML 테이블 파서 | `src/bidflow/parsing/*.py` |
| 저장/테넌시 | 사용자별 파일 경로 + 관계형 DB(SQLite 기본/PG 전환 지원) + Chroma 컬렉션, 벡터 ACL 메타데이터 | `src/bidflow/ingest/storage.py`, `src/bidflow/db/crud.py`, `src/bidflow/db/database.py` |
| 하이브리드 검색 | BM25 + Vector + Weighted RRF, 선택적 Cross-Encoder rerank | `src/bidflow/retrieval/hybrid_search.py`, `src/bidflow/retrieval/rerank.py` |
| 구조 인지 검색 | TOC 자동 감지 + chapter prefix 런타임 주입 (Q23 +60pp, Q24 +53pp 개선) | `src/bidflow/retrieval/structure_aware.py` |
| 힌트 탐지 | 정규식 기반 일정/면허 패턴 사전 탐지로 추출 보조 | `src/bidflow/extraction/hint_detector.py` |
| 추출 파이프라인 | G1->G2/G3->G4 멀티스텝 체인 + `with_structured_output` + 실패 fallback | `src/bidflow/extraction/pipeline.py`, `src/bidflow/extraction/chains.py` |
| 답변 후처리 | 추출 결과 정규화/보정 (stability_v1: 시점형/보안/공동수급 안정화) | `src/bidflow/extraction/postprocess.py` |
| 판정 엔진 | license/credit/region + budget/deadline/completeness 규칙 | `src/bidflow/validation/validator.py`, `configs/decision_rules.yaml` |
| 인증/권한 | JWT 인증 + bcrypt 해싱(legacy SHA-256 자동 마이그레이션), 역할(member/leader), 팀 프로필 1개 정책, in-memory rate limiting | `src/bidflow/api/main.py`, `src/bidflow/api/deps.py`, `src/bidflow/security/jwt_tokens.py`, `src/bidflow/security/passwords.py`, `src/bidflow/api/rate_limit.py` |
| 팀 협업 | 팀 문서 집계, 문서별 판정 요약(GO/NO-GO/REVIEW), 댓글/답글 스레딩 | `src/bidflow/api/main.py`, `frontend/components/CommentSection.tsx` |
| 프로필 관리 | 팀장 전용 회사 프로필/면허/지역/로고 편집, 팀원 읽기 전용 | `frontend/app/profile/page.tsx`, `src/bidflow/api/main.py` |
| 보안 | Input Rail + PII Filter(8종 패턴) + Tool Gate(SSRF 방어) + Output/Process Rail | `src/bidflow/security/*`, `src/bidflow/retrieval/rag_chain.py` |
| 관측/추적 | Langfuse 기반 추출/검색 체인 호출 추적 및 성능 관측 | `src/bidflow/extraction/pipeline.py`, `src/bidflow/retrieval/rag_chain.py` |
| 통합 런처 | FastAPI + Next.js 동시 기동, 포트 충돌 자동 회피, Ctrl+C 안전 종료 | `src/bidflow/launcher.py` |

### 2.3 현재 운용 상태(중요)

- Next.js 기본 업로드 경로(`/api/v1/ingest/upload`)는 `.pdf`, `.hwp`를 기준으로 운용
- 코드베이스에는 `.docx`, `.hwpx` 파서 모듈과 확장 로더 경로가 존재
- 즉, 파서 자산은 다포맷이지만 현재 기본 웹 동선은 PDF/HWP 중심
- 근거: 100문서 코퍼스 분석 결과 96건이 HWP, 4건이 PDF로 확인되어(EXP07~08), 실사용 빈도가 압도적인 두 포맷의 파싱 품질 최적화를 우선했습니다

## 3. 실험 설계 원칙과 평가 체계

### 3.1 실험 운영 원칙

- one-lever: 한 번에 하나의 변수만 변경
- 동일 지표 비교: `kw_v3`는 `kw_v3`끼리, `kw_v5`는 `kw_v5`끼리
- 단일 최고치보다 반복 안정성 우선
- 실험 산출물(JSON/CSV)과 실행 문서를 함께 남겨 재현성 확보

### 3.2 지표

- `kw_v3/v4/v5/v5b`: 키워드 정합 기반 핵심 지표
- `Perfect`: 문항 단위 완전 정답 수
- `Gate`: Dev `>=0.99`, Holdout `>=0.95`, Sealed `>=0.95`
- `Oracle / Non-oracle`: GT 의존 선택 vs GT 비의존 선택
- `Faithfulness`, `Context Recall`(RAGAS): 근거 충실도/회수율
- `stdev`: run 간 변동성

### 3.3 평가 데이터 운영

- Dev(30) + holdout_locked(10) + sealed_holdout(10) = 총 50문항
- Phase D1에서 benchmark lock 및 manifest/sha256 관리
- 실험 후반부(EXP22)에서 oracle 누수 제거 후 non-oracle 기준으로 확정

## 4. 실험 여정: 막힘과 다음 실험의 연결

아래는 "무엇이 막혔고 -> 왜 다음 실험을 했는지"를 기준으로 정리한 의사결정 로그입니다.

### 4.1 EXP01~EXP09: 기반 구축과 과적합 신호

| 구간 | 시도 | 대표 지표 | 막힌 지점 | 다음 액션 |
|---|---|---|---|---|
| EXP01~03 | 청킹/검색/프롬프트 baseline 구축 | kw_v3 ~0.82 (단일문서) | 성능 개선 폭이 제한적 | 테이블/정규화 중심 개선으로 이동 |
| EXP04~06 | table-aware 청킹, 파서/메타 개선 | 단일문서 kw_v3 0.85~0.89 | 단일문서에 과최적화 | 코퍼스 EDA + 다문서 검증 필요 |
| EXP07~08 | 코퍼스 EDA, 100문서 구조 분석 | 96 HWP + 4 PDF 확인 | HWP 테이블 파싱 한계 발견 | V4_hybrid 파서 설계 착수 |
| EXP09 | 일반화 검증(다문서 적용) | 성능 대폭 하락 | **과적합 확인** | EXP10에서 파싱/리트리벌 재최적화 착수 |

핵심 교훈: 단일 문서 최적화가 다문서 일반화로 이어지지 않는다는 것을 EXP09에서 확인하고, 이후 모든 실험을 다문서(5문서 50문항) 기준으로 전환했습니다.

### 4.2 EXP10~EXP13: 일반화 복구 시도

| 구간 | 시도 | 대표 지표 | 막힌 지점 | 다음 액션 |
|---|---|---|---|---|
| EXP10 | 다문서 testset(5문서 30문항) + V4_hybrid 파서 도입 | kw_v3 ~0.87 | 테이블 gap 잔존 | generation 개선 분리 실험 필요 |
| EXP11~12 | generation/prompt 및 retrieval 파라미터 조정 | 일부 config baseline 미달 | 개선이 불안정, 일부 조합에서 퇴행 | 실패 유형 분해(원인 진단)로 전환 |
| EXP13 | contextual retrieval 도입 시도 | 전 config baseline 미달 | **부정 결과** (한국어 RFP 도메인에서 비효과) | EXP14 오답 유형 분해로 경로 수정 |

핵심 교훈: 멀티쿼리/contextual retrieval 같은 범용 기법이 한국어 RFP 도메인에서는 오히려 성능을 저하시켰습니다(EXP13 전면 기각). 이후 "오답 원인을 먼저 분해한 뒤 정밀 개선"하는 전략으로 전환했습니다.

### 4.3 EXP14~EXP18: 실패 원인 분해 후 정밀 개선

| 실험 | 관찰된 문제 | 대응 | 결과 |
|---|---|---|---|
| EXP14 | imperfect 11건 원인 불명확 | 오류를 `gen_failure` vs `partial_retrieval`로 분해 | `gen 6 / partial 5`로 우선순위 확정 |
| EXP15 | generation 품질 부족 | self-consistency 3-shot 중심 개선 | `kw_v3=0.9258` |
| EXP16 | 지표 민감도와 선택전략 불일치 | metric v4 + SC 5-shot 검증 | `kw_v4=0.9534` (0.95 달성) |
| EXP17 | 0.99 미달 | metric v5로 재평가, 병목 확인 | `kw_v5=0.9547`, GT/retrieval 한계 확인 |
| EXP18 | 잔여 오답 지속 | GT 정제 + targeted prompt | `kw_v5=0.9851`, `28/30 perfect` |

### 4.4 EXP19~EXP20v2: 고점 달성 후 일반화/재현성 검증

| 단계 | 관찰된 문제 | 대응 | 결과 |
|---|---|---|---|
| EXP19 (Dev) | 0.99 목표 필요 | targeted prompt 보강 | Dev `kw_v5=0.9952` (29/30) 달성 |
| EXP19-B | Dev 성능이 holdout에 재현 안 됨 | holdout 검증 | Holdout raw `0.8821` (SEVERE 과적합) |
| EXP19-C | GT 품질/문항 해석 이슈 | GT 보정 + Q1 보완 | Holdout `0.9671` 회복 |
| EXP19-D2~D8 | benchmark lock 후 범용화 시도 | prompt/retrieval 조합 탐색 | D7에서 dev gate 통과, D8 sealed 미통과 |
| EXP20 D9 | split별 gate 불균형 | metric v5b(space/paren/slash 보정) | holdout/sealed gate 통과(2/3) |
| EXP20v2 D10 | dev 2건 잔여 실패 | eval_v1 후처리 추가 | 단일 run 3/3 gate 통과 |
| EXP20v2 D10-R | 단일 통과가 반복에서 유지 안 됨 | 3-run 재현성 확인 | overall pass-rate `33.3%` (불안정) |

### 4.5 EXP21: 안정화 백로그(P1~P5) 분해 실험

D10-R 불안정의 원인을 분리하기 위해 안정화 백로그를 독립 phase로 실행했습니다.

| Phase | 변경 | 결과 | 채택 여부 |
|---|---|---|---|
| P1 | `answer_postprocess=stability_v1` | `0.9968`, 48/50, 3-gate 통과 | 채택 |
| P2 | P1 + `decode_policy=type_v1` | `0.9928`, 3-gate 통과 | 보류(이득 제한) |
| P3 | P2 + consensus_v1 + deterministic retrieval | dev 급락(`0.9555`) | 기각 |
| P4 | P2 + deterministic retrieval(oracle 유지) | dev 미달(`0.9737`) | 기각 |
| P5 | P4 + guarded consensus | dev 미달(`0.9737`) | 기각 |

핵심:

- `P1`이 성능/안정성 동시 최적점
- `P1-R` 3-run에서 dev/holdout/sealed/overall gate `3/3 (100%)`
- D10-R(33.3%) 대비 재현성 구조적 개선 확인

### 4.6 EXP22: 평가 신뢰성 고도화

EXP21까지의 점수는 일부 oracle 성격이 남아 있어, EXP22에서 평가 체계를 운영 기준으로 전환했습니다.

핵심 변경:

1. `selection_mode=first_deterministic`로 GT 의존 선택 제거
2. RAGAS(Faithfulness, Context Recall) 추가
3. 3-run 반복으로 변동성 계측

결과:

- non-oracle `kw_v5` mean `0.9742`, stdev `0.0104`
- oracle mean `0.9974`, gap mean `2.33pp`
- Faithfulness `0.9402 ± 0.0045`
- Context Recall `0.9778 ± 0.0019`
- gate 패턴은 3-run 모두 `Dev FAIL / Holdout PASS / Sealed PASS`로 일관

판정:

- 점수만 높은 평가에서 벗어나, 실운영 기준의 신뢰 가능한 평가 체계로 확정

## 5. 지표/결과 시각화

### 5.1 실험 추세

![Experiment Decision Track](./final_report_assets/chart_01_metric_trends.png)

핵심 해석:

- `kw_v3`: 0.8960(초기) -> 0.9258(EXP15)
- `kw_v5`: 0.9547(EXP17) -> 0.9952(EXP19, oracle 성격)
- EXP22 mean 0.9742는 non-oracle 기준의 운영 성능

### 5.2 성능 + 재현성 (EXP21)

![EXP21 Quality Control](./final_report_assets/chart_02_quality_control.png)

| 구분 | Overall(kw_v5) | Perfect | 비고 |
|---|---:|---:|---|
| D10 단일 | 0.9874 | 46/50 | 안정화 전 |
| P1 단일(best) | 0.9968 | 48/50 | 최종 채택안 |
| P1-R 3-run 평균 | 0.9946 | - | 반복 기준 |

### 5.3 신뢰성 (EXP22)

![EXP22 Reliability](./final_report_assets/chart_03_reliability.png)

핵심 수치(3-run 평균):

- `kw_v5(non-oracle)=0.9742`
- `Faithfulness=0.9402`
- `Context Recall=0.9778`
- `Oracle gap=2.33pp`

## 6. 보안 설계 및 적용 상태

![Security Status](./final_report_assets/chart_04_security_status.png)

### 6.1 보안 레이어 상세

운영 파이프라인에 3단계(Input → Process → Output) 레일을 적용했습니다.

**Input Rail** (`security/rails/input_rail.py`):
- 프롬프트 인젝션/탈옥 시도 차단 (정규식 + 문자열 매칭)
- 탐지 패턴: "ignore previous instructions", "system prompt", "jailbreak", "DAN mode", "act as", "simulate" 등
- 탐지 시 `SecurityException` 발생 → Fail Closed

**PII Filter** (`security/pii_filter.py`):
- 8종 개인정보 패턴 탐지 및 자동 마스킹:
  - 주민등록번호, 외국인등록번호, 신용카드, 이메일, 운전면허, 전화번호, 여권번호, IP 주소
- 입력(업로드/쿼리) → 처리(문서 파싱) → 출력(LLM 응답) 3단계에서 적용
- DoS 방어: 입력 텍스트 최대 길이 제한(기본 2,000자)

**Tool Gate** (`security/tool_gate.py`):
- allowlist 기반 도구 실행 제어: `search_rfp`, `get_company_profile`만 허용
- SSRF 방어: 사설 IP 대역(10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16), localhost, 클라우드 메타데이터 엔드포인트 차단
- LangChain 도구 래핑: `apply_to_langchain_tool()`로 도구 실행 전 자동 검증

**Output Rail / Process Rail** (`security/rails/output_rail.py`, `process_rail.py`):
- 응답 내 PII 유출 탐지 및 차단
- 허용 도메인 화이트리스트 기반 제어
- 근거(Evidence) 인용 검증

**보안 로그**:
- `logs/security.log`: 위협 이벤트 (인젝션 탐지, PII 유출 시도)
- `logs/audit.log`: 일반 감사 이벤트 (로그인, 문서 접근, 추출 실행)
- RotatingFileHandler로 로그 파일 자동 회전

### 6.2 보안 원칙

- **Isolation First**: 사용자/팀 데이터를 검색 단계부터 격리 (벡터DB ACL 메타데이터)
- **Defense in Depth**: 업로드 → 파싱 → 검색 → 응답 전 단계에 다중 검증
- **Fail Closed**: 검증 실패 시 허용이 아닌 차단이 기본값
- **Auditability**: 모든 위협/정상 이벤트를 분리 기록하여 포렌식 가능

## 7. 사내 적용 관점 정리

### 7.1 인증/권한/프로필 정책

- 인증: JWT(HS256) 토큰 기반, bcrypt 비밀번호 해싱 (legacy SHA-256 로그인 시 자동 업그레이드)
- 역할 분리: `member`, `leader`
- 팀 프로필 1개 정책: 팀장이 갱신, 팀원 fallback 동기화
- API 보호: in-memory rate limiting (auth 20req/60s, general 240req/60s, 429 + Retry-After)
- `/auth/me`, `/api/v1/validate`, `/api/v1/team/decision/*` 경로에서 정책 일관 적용

### 7.2 데이터 경계

- 사용자 경로: `data/accounts/{user_id}/...`
- 팀 공유 경로: `data/shared/teams/{team_name}/...`
- 벡터DB ACL 메타데이터로 조회 범위 제한

### 7.3 협업 UX

- 팀 문서 목록 + 문서별 GO/NO-GO/REVIEW 요약
- 댓글/답글/삭제로 리뷰 이력 관리

## 8. 팀 기여 정리

| 이름 | 핵심 기여 |
|---|---|
| 임창현 | RAG 파이프라인 설계/실험 운영, 최종 성능/안정화 의사결정 주도 |
| 김보윤 | QueryAnalyzer/DecisionEngine 계열, 인증/팀 워크스페이스/프로필 정책 |
| 김슬기 | Front-loading/힌트 주입/구조 인지 검색, 보안 레이어 및 웹 연동 고도화 |

근거: `docs/final_presentation/team_contributions.md`

## 9. 한계와 다음 단계

현재 한계:

- **성능**: non-oracle 기준 dev gate(0.99) 미달 구조 존재 (3-run 모두 dev FAIL, mean 0.9741)
- **평가**: judge context mismatch (chapter prefix 미전달 → RAGAS false negative 2건) 등 평가 파이프라인 세부 개선 여지
- **인증**: JWT + bcrypt로 전환 완료. 현재 과제는 refresh token/강제 로그아웃 정책 추가
- **데이터베이스**: PostgreSQL 전환 경로(`BIDFLOW_DATABASE_URL`) 지원 완료. 운영 환경에서는 커넥션 풀/백업정책 튜닝 필요
- **API 보안**: 기본 rate limiting 적용 완료. 분산 인스턴스 환경에서는 Redis 기반 분산 limiter로 확장 필요
- **프론트엔드**: 전역 lint debt 및 배포 자동화 미완, SSR 미활용(전 페이지 CSR)

다음 단계(우선순위):

1. EXP22 후속: judge context 정합 개선(chapter prefix 포함) + gate 기준 재정의(non-oracle 기준 0.97로 조정)
2. 인증 강화(후속): refresh token + 세션 강제 무효화(로그아웃/탈퇴/비밀번호 변경 연동)
3. 평가 자동화: 정기 리그레션 + 품질 임계치 알람
4. 배포 안정화: CI/CD, 로그 대시보드, 장애 대응 절차
5. 보안 확장: Process/Output Rail 정책 전면 적용, rate limiting을 Redis 기반 분산 제어로 확장
6. DB 확장: PostgreSQL 운영 튜닝(인덱스/풀 사이즈/백업/복구 리허설)

## 10. 재현 체크리스트

1. `docs/planning/HISTORY_v2_execution.md`와 `data/experiments/*` 수치 일치 확인
2. `single-run`, `3-run mean`, `best-run` 라벨 분리 표기 확인
3. 구현 완료 기능 vs 확장 예정 기능 구분 확인
4. 실험 의사결정의 연결(막힘 -> 다음 실험)이 문서에 명시되었는지 확인
5. 팀원별 기여가 문제/구현/성과 3축으로 설명 가능한지 확인

---

## 참고 소스

- `docs/planning/HISTORY_v2_execution.md`
- `docs/planning/EXP20v2_phase_d10_execution.md`
- `docs/planning/EXP21_phase_stability_execution.md`
- `docs/planning/EXP22_llmjudge_execution.md`
- `docs/planning/next_fastapi_unification_execution_2026-02-26.md`
